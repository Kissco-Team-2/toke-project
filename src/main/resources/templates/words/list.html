<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>ë¹„ì¦ˆë‹ˆìŠ¤ ì¼ë³¸ì–´ í‘œí˜„</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">

<style>
body {
	font-family: "Noto Sans KR", sans-serif;
}

.word-row {
	display: flex;
	align-items: center; /* ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
	padding: 0.8rem 0;
	border-bottom: 1px solid #eee;
	gap: 1rem; /* í•„ìš”ì‹œ ì¡°ì • */
}

/* ì•„ì´ì½˜ ìë¦¬ ê³ ì •í­ */
.word-icon {
	width: 28px; /* ì•„ì´ì½˜ ìë¦¬ë¥¼ ê³ ì • (í•„ìš”ì‹œ 24/32 ë“±ìœ¼ë¡œ ì¡°ì •) */
	min-width: 28px; /* í­ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ë³´ì¥ */
	height: 24px;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-size: 1.1rem; /* ì´ëª¨ì§€ í¬ê¸° */
	line-height: 1;
	color: #444;
}

/* ì•¡ì…˜ ê·¸ë£¹(ì•„ì´ì½˜ + ì²´í¬ë°•ìŠ¤) ì •ë ¬ */
.word-actions {
	/* ì˜¤ë¥¸ìª½ ì •ë ¬ì€ ë¶€ëª¨ì—ì„œ ms-autoë¡œ ì²˜ë¦¬ (ì´ë¯¸ ì‚¬ìš©) */
	gap: 8px;
}

.tab-btn {
	background: #000;
	color: #fff;
	font-weight: 400;
	border: 0;
	border-radius: 6px;
	padding: 10px;
	white-space: nowrap;
	text-decoration: none;
	/* flex:1 ì œê±° */
}

.tab-btn.active {
	background: #A6B4FF !important;
}

.btn-soft-green {
	background: #caf7cf;
	color: #000;
	border: 0;
	font-weight: 600;
}

.btn-soft-green:hover {
	background: #bfe3ce;
	color: #0f5132;
}

.word-box {
	background: #fff;
	border-radius: 16px;
	padding: 1rem;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
	max-height: 400px; /* ëª©ë¡ ë†’ì´ ì œí•œ */
	overflow-y: hidden; /* ë„˜ì¹˜ë©´ hidden */
	position: relative;
}

.word-row {
	display: flex;
	padding: 0.8rem 0;
	border-bottom: 1px solid #eee;
	gap: 4rem;
}

.word-ja {
	flex: 2;
}

.word-ka {
	flex: 2;
}

.word-ko {
	flex: 2;
	color: #333;
}

.word-ex {
	flex: 4;
	color: #555;
	font-size: 0.95rem;
}

/* ìŠ¤í¬ë¡¤ ë²„íŠ¼ (ëª©ë¡ ë°”ê¹¥ì— ìœ„ì¹˜) */
.scroll-btn {
	color: #fff;
	background: #d9d9d9;
	border-radius: 50%;
	width: 36px;
	height: 36px;
	display: flex;
	justify-content: center;
	align-items: center;
	cursor: pointer;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.index-link {
	margin: 0 .5rem;
	color: #aaa;
	text-decoration: none;
	font-weight: 500;
	font-size: 1rem;
}

.index-link:hover {
	color: #000;
	font-weight: 600;
}

.index-link.active {
	color: #000;
	font-weight: 700;
	text-decoration: underline;
}
</style>
</head>
<body class="d-flex flex-column min-vh-100" style="margin: 0;">

	<header th:replace="fragments/header :: site-header"></header>

	<main class="flex-grow-1" style="margin: 0; padding: 0;">

		<h2 class="mb-4 text-center fw-bold" style="margin-top: 3rem;">ë¹„ì¦ˆë‹ˆìŠ¤
			ì¼ë³¸ì–´ í‘œí˜„</h2>

		<!-- ê²€ìƒ‰ -->
		<div class="d-flex justify-content-center mb-3">
			<form method="get" th:action="@{/words}" class="d-flex w-25">
				<input type="text" name="q" th:value="${q}"
					class="form-control me-2"> <input type="hidden" name="mode"
					th:value="${mode}">
				<button class="btn btn-soft-green" style="width: 100px">ê²€ìƒ‰</button>
			</form>
		</div>


		<!-- ì •ë ¬ íƒ­ -->
		<div class="container" style="padding: 20px;">
			<div class="d-flex justify-content-between">
				<div class="d-flex gap-2 mb-3">
					<a th:href="@{/words(mode='ko', q=${q}, category=${category})}"
						class="tab-btn" th:classappend="${mode=='ko'}? ' active'">ê°€ë‚˜ë‹¤ìˆœ</a>
					<a th:href="@{/words(mode='ja', q=${q}, category=${category})}"
						class="tab-btn" th:classappend="${mode=='ja'}? ' active'">íˆë¼ê°€ë‚˜ìˆœ</a>
					<a th:href="@{/words(mode='cat', q=${q})}" class="tab-btn"
						th:classappend="${mode=='cat'}? ' active'">ì¹´í…Œê³ ë¦¬ë³„</a> <a
						th:href="@{/words(mode='recent', q=${q}, category=${category})}"
						class="tab-btn" th:classappend="${mode=='recent'}? ' active'">ìµœê·¼
						ë“±ë¡ìˆœ</a>


				</div>
				<button class="btn btn-black m-2" data-bs-toggle="modal"
					data-bs-target="#add_to_mylist_modal">ë‚´ ë‹¨ì–´ì¥ì— ì¶”ê°€</button>
			</div>


			<!-- ëª©ë¡ ë°•ìŠ¤ -->
			<div class="container p-2">

				<!-- í•œê¸€ ì¸ë±ìŠ¤: ê°€ë‚˜ë‹¤ìˆœ ëª¨ë“œì¼ ë•Œë§Œ -->
				<div th:if="${mode == 'ko'}" class="hangeul-index mb-3">
					<a th:each="g : ${'ê°€,ë‚˜,ë‹¤,ë¼,ë§ˆ,ë°”,ì‚¬,ì•„,ì,ì°¨,ì¹´,íƒ€,íŒŒ,í•˜'.split(',')}"
						th:href="@{/words(mode='ko', group=${g}, q=${q}, category=${category})}"
						th:text="${g}" class="index-link"
						th:classappend="${group==g}?'fw-bold text-dark selected':''"></a>
				</div>

				<!-- ì¼ë³¸ì–´ ì¸ë±ìŠ¤: íˆë¼ê°€ë‚˜ìˆœ ëª¨ë“œì¼ ë•Œë§Œ -->
				<div th:if="${mode == 'ja'}" class="kana-index mb-3">
					<a th:each="g : ${'ã‚,ã‹,ã•,ãŸ,ãª,ã¯,ã¾,ã‚„,ã‚‰,ã‚'.split(',')}"
						th:href="@{/words(mode='ja', group=${g}, q=${q}, category=${category})}"
						th:text="${g}" class="index-link"
						th:classappend="${group==g}?'fw-bold text-dark selected':''"></a>
				</div>

				<div th:if="${mode == 'cat'}" class="category-index mb-3">
					<a th:each="c : ${'ê³ ê° ëŒ€ì‘,ë©”ì¼,ë³´ê³ ,ì¸ì‚¬,ì „í™”,ì œì•ˆ,íšŒì˜'.split(',')}"
						th:href="@{/words(mode='cat', category=${c}, q=${q})}"
						th:text="${c}" class="index-link"
						th:classappend="${category==c}?'fw-bold text-dark selected':''"></a>
				</div>

				<div class="word-box" id="wordBox">


					<div class="p-2">
						<div th:each="w : ${words}" class="word-row m-2">
							<div class="word-ja" th:text="${w.japaneseWord}">ã”é€£çµ¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</div>
							<div class="word-ka" th:text="${w.readingKana}">ã”ã‚Œã‚“ã‚‰ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</div>
							<div class="word-ko" th:text="${w.koreanMeaning}">ì—°ë½ ê°ì‚¬í•©ë‹ˆë‹¤.</div>
							<div class="word-ex" th:text="${w.exampleSentenceJp}">é€ã£ã¦ã„ãŸã ã„ãŸè³‡æ–™ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚</div>
							<!-- ì˜¤ë¥¸ìª½ ì•¡ì…˜ ì˜ì—­: ì•„ì´ì½˜ + ì²´í¬ë°•ìŠ¤ -->
							<div class="d-flex align-items-center ms-auto word-actions">
								<!-- ê³ ì •í­ ì•„ì´ì½˜ ì˜ì—­: í•­ìƒ ë Œë”, ì¡°ê±´ì— ë”°ë¼ í…ìŠ¤íŠ¸(ì´ëª¨ì§€)ë¥¼ ì±„ì›€ -->
								<span class="word-icon"
									th:text="${myCustomJp != null and normJpById != null and myCustomJp.contains(normJpById[w.id])} ? 'ğŸ“’' : ''"
									title="ì´ë¯¸ ë‚´ ë‹¨ì–´ì¥ì— ìˆìŒ"></span>

								<!-- ê¸°ì¡´ ì²´í¬ë°•ìŠ¤ -->
								<div class="form-check ms-2">
									<input class="form-check-input circle-checkbox" type="checkbox"
										name="selectedWords" th:value="${w.id}">
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>


		<!-- ìŠ¤í¬ë¡¤ ë²„íŠ¼ -->
		<!-- ë²„íŠ¼ ê·¸ë£¹ -->
		<div class="d-flex justify-content-center"
			style="margin-bottom: 2rem; gap: 16px;">
			<div class="scroll-btn" onclick="scrollUp()">â–²</div>
			<div class="scroll-btn" onclick="scrollDown()">â–¼</div>
		</div>

		<div th:replace="fragments/add_to_mylist_modal :: add_to_mylist_modal"></div>

	</main>
	<footer th:replace="fragments/footer :: site-footer"
		style="margin-top: 0; padding-top: 0; background: #000;"></footer>

	<script>
		function scrollDown() {
			const box = document.getElementById('wordBox');
			box.scrollBy({
				top : 120,
				behavior : 'smooth'
			});
		}

		function scrollUp() {
			const box = document.getElementById('wordBox');
			box.scrollBy({
				top : -120,
				behavior : 'smooth'
			});
		}
	</script>
	<script>
document.getElementById('add_to_mylist_modal')
  .addEventListener('show.bs.modal', function () {
    const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
    const ids = Array.from(checked).map(cb => cb.value);
    document.getElementById('selectedWordIds').value = ids.join(',');
  });
</script>

	<script>
  // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì„ íƒëœ ì²´í¬ë°•ìŠ¤ë“¤ì„ ëª¨ì•„ì„œ selectedWordIdsì— ì±„ìš°ëŠ” ê¸°ì¡´ ì½”ë“œ
  document.getElementById('add_to_mylist_modal')
    .addEventListener('show.bs.modal', function () {
      const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
      const ids = Array.from(checked).map(cb => cb.value);
      const hidden = document.getElementById('selectedWordIds');
      if (hidden) hidden.value = ids.join(',');
  });

  // ì‹¤ì œ ì œì¶œ ì „ì— ê²€ì‚¬: ë¹„ì–´ìˆìœ¼ë©´ alert ë„ìš°ê³  ì œì¶œ ë§‰ìŒ
  const addForm = document.getElementById('addToMyListForm'); // ëª¨ë‹¬ ì•ˆì˜ form id
  if (addForm) {
    addForm.addEventListener('submit', function(e) {
      const hidden = document.getElementById('selectedWordIds');
      const ids = hidden ? hidden.value.trim() : '';
      if (!ids) {
        e.preventDefault();
        alert('ì„ íƒëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€í•  ë‹¨ì–´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”');
        // ëª¨ë‹¬ ë‹«ì§€ ì•ŠìŒ, ì‚¬ìš©ìê°€ ì„ íƒí•˜ë„ë¡ í•¨
      }
    });
  }
</script>

	<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('add_to_mylist_modal');
  const form = document.getElementById('addToMyListForm');
  const hidden = document.getElementById('selectedWordIds');
  const errorDiv = document.getElementById('addToMyListError');

  // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì²´í¬ëœ idë“¤ì„ ì±„ì›Œë„£ìŒ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
  if (modalEl) {
    modalEl.addEventListener('show.bs.modal', function () {
      const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
      const ids = Array.from(checked).map(cb => cb.value);
      if (hidden) hidden.value = ids.join(',');
    });
  }

  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë§‰ìŒ â€” ë¨¼ì € ê²€ì‚¬

    // ì´ˆê¸°í™”
    if (errorDiv) {
      errorDiv.style.display = 'none';
      errorDiv.textContent = '';
    }

    const ids = hidden ? hidden.value.trim() : '';
    if (!ids) {
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'ì„ íƒëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€í•  ë‹¨ì–´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.';
      } else {
        alert('ì„ íƒëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€í•  ë‹¨ì–´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      }
      return; // ì œì¶œ ì¤‘ì§€
    }

    const listIdEl = document.getElementById('addToListSelect');
    const listId = listIdEl ? listIdEl.value : null;
    if (!listId) {
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'ë‹¨ì–´ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.';
      }
      return;
    }

    // ì„œë²„ì— ê²€ì‚¬ ìš”ì²­
    const params = new URLSearchParams();
    params.append('selectedWordIds', ids);
    params.append('listId', listId);

    fetch('/lists/addWords/check', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: params.toString(),
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(json => {
      if (!json) {
        throw new Error('Invalid server response');
      }
      if (json.ok === true) {
        // ê²€ì‚¬ í†µê³¼: ì´ì œ í¼ì„ ì‹¤ì œë¡œ ì œì¶œí•´ì„œ ì„œë²„ì—ì„œ ì¶”ê°€ ì²˜ë¦¬ (ê¸°ì¡´ POST /lists/addWords)
        // ì‚¬ìš©ìê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬ë¥¼ í•˜ê³  ì‹¶ë‹¤ë©´ ê·¸ëƒ¥ submit()
        form.removeEventListener('submit', arguments.callee); // remove handler to avoid loop
        form.submit();
      } else {
        // ì¤‘ë³µ ìˆìŒ -> ë³´ì—¬ì£¼ê¸°
        const dups = json.duplicates || [];
        if (dups.length > 0) {
          // ì˜ˆì‹œ ë©”ì‹œì§€: "xxx (JP) ëŠ” ì´ë¯¸ í•´ë‹¹ ë‹¨ì–´ì¥ì— ì¡´ì¬í•©ë‹ˆë‹¤." â€” ì—¬ëŸ¬ê°œë©´ ì¤„ë°”ê¿ˆìœ¼ë¡œ í‘œì‹œ
          const msgs = dups.map(d => (d.jp ? `"${d.jp}"` : `ID:${d.id}`) + ' ëŠ” ì´ë¯¸ í•´ë‹¹ ë‹¨ì–´ì¥ì— ì¡´ì¬í•©ë‹ˆë‹¤.');
          if (errorDiv) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = msgs.join('<br>');
          } else {
            alert(msgs.join('\\n'));
          }
        } else {
          // ê¸°íƒ€ ì—ëŸ¬ ë©”ì‹œì§€
          if (errorDiv) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = json.message || 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          } else {
            alert(json.message || 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }
      }
    })
    .catch(err => {
      console.error(err);
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      } else {
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  });
});
</script>

	<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('add_to_mylist_modal');
  const form = document.getElementById('addToMyListForm');
  const hidden = document.getElementById('selectedWordIds');
  const errorDiv = document.getElementById('addToMyListError');

  function clearError() {
    if (!errorDiv) return;
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
  }

  // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ: ì„ íƒëœ ì²´í¬ë°•ìŠ¤ ì±„ìš°ê¸° + ì—ëŸ¬ ì´ˆê¸°í™”
  if (modalEl) {
    modalEl.addEventListener('show.bs.modal', function () {
      // ì—ëŸ¬ ì œê±°
      clearError();

      // ì²´í¬ëœ ë‹¨ì–´ id ì±„ìš°ê¸°
      try {
        const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
        const ids = Array.from(checked).map(cb => cb.value);
        if (hidden) hidden.value = ids.join(',');
      } catch (e) { /* ignore */ }
    });

    // ëª¨ë‹¬ì´ ì™„ì „íˆ ë‹«í ë•Œ: ì—ëŸ¬ ì œê±° ë° í¼ ì´ˆê¸°í™”(optional)
    modalEl.addEventListener('hidden.bs.modal', function () {
      clearError();
      // í¼ ë¦¬ì…‹(í•„ìš” ì—†ìœ¼ë©´ ì£¼ì„ì²˜ë¦¬)
      if (form) {
        // ë‹¨, form.reset()ì€ select ë“±ì˜ ê°’ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
        // í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ ì•„ë˜ ì¤„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
        form.reset();
      }
      if (hidden) hidden.value = '';
    });
  }

  // ê¸°ì¡´ submit ê°€ë¡œì±„ê¸° ì½”ë“œê°€ ìˆë‹¤ë©´, ì„±ê³µì ìœ¼ë¡œ ì œì¶œëœ ì´í›„ì—ë„ ì—ëŸ¬ë¥¼ ì§€ìš°ë„ë¡ í•´ë‘ë©´ ì•ˆì „í•©ë‹ˆë‹¤
  if (form) {
    form.addEventListener('submit', function () {
      // ì œì¶œ ì‹œ(ê²€ì‚¬ í†µê³¼ í›„ ì§„ì§œ submit) ì—ëŸ¬ ì œê±°
      clearError();
    });
  }
});
</script>


	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
