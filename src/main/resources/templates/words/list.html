<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>비즈니스 일본어 표현</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">

<style>
body {
	font-family: "Noto Sans KR", sans-serif;
}

.word-row {
	display: flex;
	align-items: center; /* 세로 가운데 정렬 */
	padding: 0.8rem 0;
	border-bottom: 1px solid #eee;
	gap: 1rem; /* 필요시 조정 */
}

/* 아이콘 자리 고정폭 */
.word-icon {
	width: 28px; /* 아이콘 자리를 고정 (필요시 24/32 등으로 조정) */
	min-width: 28px; /* 폭이 줄어들지 않도록 보장 */
	height: 24px;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	font-size: 1.1rem; /* 이모지 크기 */
	line-height: 1;
	color: #444;
}

/* 액션 그룹(아이콘 + 체크박스) 정렬 */
.word-actions {
	/* 오른쪽 정렬은 부모에서 ms-auto로 처리 (이미 사용) */
	gap: 8px;
}

.tab-btn {
	background: #000;
	color: #fff;
	font-weight: 400;
	border: 0;
	border-radius: 6px;
	padding: 10px;
	white-space: nowrap;
	text-decoration: none;
	/* flex:1 제거 */
}

.tab-btn.active {
	background: #A6B4FF !important;
}

.btn-soft-green {
	background: #caf7cf;
	color: #000;
	border: 0;
	font-weight: 600;
}

.btn-soft-green:hover {
	background: #bfe3ce;
	color: #0f5132;
}

.word-box {
	background: #fff;
	border-radius: 16px;
	padding: 1rem;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
	max-height: 400px; /* 목록 높이 제한 */
	overflow-y: hidden; /* 넘치면 hidden */
	position: relative;
}

.word-row {
	display: flex;
	padding: 0.8rem 0;
	border-bottom: 1px solid #eee;
	gap: 4rem;
}

.word-ja {
	flex: 2;
}

.word-ka {
	flex: 2;
}

.word-ko {
	flex: 2;
	color: #333;
}

.word-ex {
	flex: 4;
	color: #555;
	font-size: 0.95rem;
}

/* 스크롤 버튼 (목록 바깥에 위치) */
.scroll-btn {
	color: #fff;
	background: #d9d9d9;
	border-radius: 50%;
	width: 36px;
	height: 36px;
	display: flex;
	justify-content: center;
	align-items: center;
	cursor: pointer;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.index-link {
	margin: 0 .5rem;
	color: #aaa;
	text-decoration: none;
	font-weight: 500;
	font-size: 1rem;
}

.index-link:hover {
	color: #000;
	font-weight: 600;
}

.index-link.active {
	color: #000;
	font-weight: 700;
	text-decoration: underline;
}
</style>
</head>
<body class="d-flex flex-column min-vh-100" style="margin: 0;">

	<header th:replace="fragments/header :: site-header"></header>

	<main class="flex-grow-1" style="margin: 0; padding: 0;">

		<h2 class="mb-4 text-center fw-bold" style="margin-top: 3rem;">비즈니스
			일본어 표현</h2>

		<!-- 검색 -->
		<div class="d-flex justify-content-center mb-3">
			<form method="get" th:action="@{/words}" class="d-flex w-25">
				<input type="text" name="q" th:value="${q}"
					class="form-control me-2"> <input type="hidden" name="mode"
					th:value="${mode}">
				<button class="btn btn-soft-green" style="width: 100px">검색</button>
			</form>
		</div>


		<!-- 정렬 탭 -->
		<div class="container" style="padding: 20px;">
			<div class="d-flex justify-content-between">
				<div class="d-flex gap-2 mb-3">
					<a th:href="@{/words(mode='ko', q=${q}, category=${category})}"
						class="tab-btn" th:classappend="${mode=='ko'}? ' active'">가나다순</a>
					<a th:href="@{/words(mode='ja', q=${q}, category=${category})}"
						class="tab-btn" th:classappend="${mode=='ja'}? ' active'">히라가나순</a>
					<a th:href="@{/words(mode='cat', q=${q})}" class="tab-btn"
						th:classappend="${mode=='cat'}? ' active'">카테고리별</a> <a
						th:href="@{/words(mode='recent', q=${q}, category=${category})}"
						class="tab-btn" th:classappend="${mode=='recent'}? ' active'">최근
						등록순</a>


				</div>
				<button class="btn btn-black m-2" data-bs-toggle="modal"
					data-bs-target="#add_to_mylist_modal">내 단어장에 추가</button>
			</div>


			<!-- 목록 박스 -->
			<div class="container p-2">

				<!-- 한글 인덱스: 가나다순 모드일 때만 -->
				<div th:if="${mode == 'ko'}" class="hangeul-index mb-3">
					<a th:each="g : ${'가,나,다,라,마,바,사,아,자,차,카,타,파,하'.split(',')}"
						th:href="@{/words(mode='ko', group=${g}, q=${q}, category=${category})}"
						th:text="${g}" class="index-link"
						th:classappend="${group==g}?'fw-bold text-dark selected':''"></a>
				</div>

				<!-- 일본어 인덱스: 히라가나순 모드일 때만 -->
				<div th:if="${mode == 'ja'}" class="kana-index mb-3">
					<a th:each="g : ${'あ,か,さ,た,な,は,ま,や,ら,わ'.split(',')}"
						th:href="@{/words(mode='ja', group=${g}, q=${q}, category=${category})}"
						th:text="${g}" class="index-link"
						th:classappend="${group==g}?'fw-bold text-dark selected':''"></a>
				</div>

				<div th:if="${mode == 'cat'}" class="category-index mb-3">
					<a th:each="c : ${'고객 대응,메일,보고,인사,전화,제안,회의'.split(',')}"
						th:href="@{/words(mode='cat', category=${c}, q=${q})}"
						th:text="${c}" class="index-link"
						th:classappend="${category==c}?'fw-bold text-dark selected':''"></a>
				</div>

				<div class="word-box" id="wordBox">


					<div class="p-2">
						<div th:each="w : ${words}" class="word-row m-2">
							<div class="word-ja" th:text="${w.japaneseWord}">ご連絡ありがとうございます。</div>
							<div class="word-ka" th:text="${w.readingKana}">ごれんらくありがとうございます。</div>
							<div class="word-ko" th:text="${w.koreanMeaning}">연락 감사합니다.</div>
							<div class="word-ex" th:text="${w.exampleSentenceJp}">送っていただいた資料を確認しました。</div>
							<!-- 오른쪽 액션 영역: 아이콘 + 체크박스 -->
							<div class="d-flex align-items-center ms-auto word-actions">
								<!-- 고정폭 아이콘 영역: 항상 렌더, 조건에 따라 텍스트(이모지)를 채움 -->
								<span class="word-icon"
									th:text="${myCustomJp != null and normJpById != null and myCustomJp.contains(normJpById[w.id])} ? '📒' : ''"
									title="이미 내 단어장에 있음"></span>

								<!-- 기존 체크박스 -->
								<div class="form-check ms-2">
									<input class="form-check-input circle-checkbox" type="checkbox"
										name="selectedWords" th:value="${w.id}">
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>


		<!-- 스크롤 버튼 -->
		<!-- 버튼 그룹 -->
		<div class="d-flex justify-content-center"
			style="margin-bottom: 2rem; gap: 16px;">
			<div class="scroll-btn" onclick="scrollUp()">▲</div>
			<div class="scroll-btn" onclick="scrollDown()">▼</div>
		</div>

		<div th:replace="fragments/add_to_mylist_modal :: add_to_mylist_modal"></div>

	</main>
	<footer th:replace="fragments/footer :: site-footer"
		style="margin-top: 0; padding-top: 0; background: #000;"></footer>

	<script>
		function scrollDown() {
			const box = document.getElementById('wordBox');
			box.scrollBy({
				top : 120,
				behavior : 'smooth'
			});
		}

		function scrollUp() {
			const box = document.getElementById('wordBox');
			box.scrollBy({
				top : -120,
				behavior : 'smooth'
			});
		}
	</script>
	<script>
document.getElementById('add_to_mylist_modal')
  .addEventListener('show.bs.modal', function () {
    const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
    const ids = Array.from(checked).map(cb => cb.value);
    document.getElementById('selectedWordIds').value = ids.join(',');
  });
</script>

	<script>
  // 모달이 열릴 때 선택된 체크박스들을 모아서 selectedWordIds에 채우는 기존 코드
  document.getElementById('add_to_mylist_modal')
    .addEventListener('show.bs.modal', function () {
      const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
      const ids = Array.from(checked).map(cb => cb.value);
      const hidden = document.getElementById('selectedWordIds');
      if (hidden) hidden.value = ids.join(',');
  });

  // 실제 제출 전에 검사: 비어있으면 alert 띄우고 제출 막음
  const addForm = document.getElementById('addToMyListForm'); // 모달 안의 form id
  if (addForm) {
    addForm.addEventListener('submit', function(e) {
      const hidden = document.getElementById('selectedWordIds');
      const ids = hidden ? hidden.value.trim() : '';
      if (!ids) {
        e.preventDefault();
        alert('선택된 단어가 없습니다. 추가할 단어를 선택해 주세요');
        // 모달 닫지 않음, 사용자가 선택하도록 함
      }
    });
  }
</script>

	<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('add_to_mylist_modal');
  const form = document.getElementById('addToMyListForm');
  const hidden = document.getElementById('selectedWordIds');
  const errorDiv = document.getElementById('addToMyListError');

  // 모달이 열릴 때 체크된 id들을 채워넣음 (기존 코드 유지)
  if (modalEl) {
    modalEl.addEventListener('show.bs.modal', function () {
      const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
      const ids = Array.from(checked).map(cb => cb.value);
      if (hidden) hidden.value = ids.join(',');
    });
  }

  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault(); // 기본 제출 막음 — 먼저 검사

    // 초기화
    if (errorDiv) {
      errorDiv.style.display = 'none';
      errorDiv.textContent = '';
    }

    const ids = hidden ? hidden.value.trim() : '';
    if (!ids) {
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = '선택된 단어가 없습니다. 추가할 단어를 선택해 주세요.';
      } else {
        alert('선택된 단어가 없습니다. 추가할 단어를 선택해 주세요.');
      }
      return; // 제출 중지
    }

    const listIdEl = document.getElementById('addToListSelect');
    const listId = listIdEl ? listIdEl.value : null;
    if (!listId) {
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = '단어장을 선택해 주세요.';
      }
      return;
    }

    // 서버에 검사 요청
    const params = new URLSearchParams();
    params.append('selectedWordIds', ids);
    params.append('listId', listId);

    fetch('/lists/addWords/check', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: params.toString(),
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(json => {
      if (!json) {
        throw new Error('Invalid server response');
      }
      if (json.ok === true) {
        // 검사 통과: 이제 폼을 실제로 제출해서 서버에서 추가 처리 (기존 POST /lists/addWords)
        // 사용자가 리다이렉트 처리를 하고 싶다면 그냥 submit()
        form.removeEventListener('submit', arguments.callee); // remove handler to avoid loop
        form.submit();
      } else {
        // 중복 있음 -> 보여주기
        const dups = json.duplicates || [];
        if (dups.length > 0) {
          // 예시 메시지: "xxx (JP) 는 이미 해당 단어장에 존재합니다." — 여러개면 줄바꿈으로 표시
          const msgs = dups.map(d => (d.jp ? `"${d.jp}"` : `ID:${d.id}`) + ' 는 이미 해당 단어장에 존재합니다.');
          if (errorDiv) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = msgs.join('<br>');
          } else {
            alert(msgs.join('\\n'));
          }
        } else {
          // 기타 에러 메시지
          if (errorDiv) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = json.message || '중복 확인 중 오류가 발생했습니다.';
          } else {
            alert(json.message || '중복 확인 중 오류가 발생했습니다.');
          }
        }
      }
    })
    .catch(err => {
      console.error(err);
      if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = '서버와 통신 중 오류가 발생했습니다.';
      } else {
        alert('서버와 통신 중 오류가 발생했습니다.');
      }
    });
  });
});
</script>

	<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('add_to_mylist_modal');
  const form = document.getElementById('addToMyListForm');
  const hidden = document.getElementById('selectedWordIds');
  const errorDiv = document.getElementById('addToMyListError');

  function clearError() {
    if (!errorDiv) return;
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
  }

  // 모달이 열릴 때: 선택된 체크박스 채우기 + 에러 초기화
  if (modalEl) {
    modalEl.addEventListener('show.bs.modal', function () {
      // 에러 제거
      clearError();

      // 체크된 단어 id 채우기
      try {
        const checked = document.querySelectorAll('input[name="selectedWords"]:checked');
        const ids = Array.from(checked).map(cb => cb.value);
        if (hidden) hidden.value = ids.join(',');
      } catch (e) { /* ignore */ }
    });

    // 모달이 완전히 닫힐 때: 에러 제거 및 폼 초기화(optional)
    modalEl.addEventListener('hidden.bs.modal', function () {
      clearError();
      // 폼 리셋(필요 없으면 주석처리)
      if (form) {
        // 단, form.reset()은 select 등의 값을 초기값으로 되돌립니다.
        // 필요하지 않다면 아래 줄을 주석 처리하세요.
        form.reset();
      }
      if (hidden) hidden.value = '';
    });
  }

  // 기존 submit 가로채기 코드가 있다면, 성공적으로 제출된 이후에도 에러를 지우도록 해두면 안전합니다
  if (form) {
    form.addEventListener('submit', function () {
      // 제출 시(검사 통과 후 진짜 submit) 에러 제거
      clearError();
    });
  }
});
</script>


	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
