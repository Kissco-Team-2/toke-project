<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>로그인</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">
</head>
<style>
body {
	background: #f7f7f7;
}

.card-soft {
	border: 0;
	border-radius: 12px;
	background: #fff;
	box-shadow: 0 10px 24px rgba(0, 0, 0, .06);
}

.card-body {
	padding: 48px 40px;
}

.form-control {
	background: #efefef;
	border-radius: 8px;
}

.btn-soft-green {
	background: #caf7cf;
	color: #000;
	border: 0;
	font-weight: 600;
}

.btn-soft-green:hover {
	background: #bfe3ce;
	color: #0f5132;
}

.btn-black {
	background: #000;
	color: #fff;
	border: 0;
	font-weight: 600;
}

.btn-black:hover {
	background: #111;
	color: #fff;
}

.form-control::placeholder {
	color: #c0c0c0;
	opacity: 1;
	font-size: 0.8rem;
	opacity: 1;
}
</style>
<body class="d-flex flex-column min-vh-100">
	<header th:replace="fragments/header :: site-header"></header>

	<main class="flex-grow-1">
		<div class="container p-5">
			<div class="row justify-content-center">
				<div class="card card-soft"
					style="width: 670px; height: 480px; padding: 24px;">
					<div class="card-body">
						<h2 class="text-center fw-bold">로그인</h2>
						<div style="padding: 20px;">

							<form th:action="@{/login}" method="post" class="mt-3">
								<div class="row mb-4 align-items-center">
									<div class="col-12 mx-auto">
										<input type="text" id="email" name="email"
											class="form-control" placeholder="이메일 입력">
									</div>
								</div>

								<div class="row mb-4 align-items-center">
									<div class="col-12 mx-auto">
										<input type="password" id="password" name="password"
											class="form-control" placeholder="비밀번호 입력">
									</div>
								</div>
								<div class="d-flex justify-content-end"
									style="margin-top: 2rem;">
									<button type="button"
										class="btn btn-link text-dark small me-3 p-0"
										data-bs-toggle="modal" data-bs-target="#findAccountModal">
										이메일 / 비밀번호 찾기</button>

								</div>
								<div class="row g-3" style="margin-top: 0.3rem;">
									<div class="col-6 d-grid">
										<button type="submit" class="btn btn-soft-green py-2">로그인</button>
									</div>
									<div class="col-6 d-grid">
										<a th:href="@{/register}" class="btn btn-black py-2">회원가입</a>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
	
	<div th:replace="fragments/find_account_modal :: findAccountModal"></div>
	<div
		th:replace="fragments/find_email_result_modal :: findEmailResultModal"></div>
	<div
		th:replace="fragments/find_password_verify_modal :: findPasswordVerifyModal"></div>
	<div
		th:replace="fragments/find_password_reset_modal :: findPasswordResetModal"></div>
	<div
		th:replace="fragments/reset_password_success_modal :: resetPasswordSuccessModal"></div>
		
		<footer th:replace="fragments/footer :: site-footer"></footer>

	<script th:inline="javascript">
		document.addEventListener('DOMContentLoaded', function() {
			// 서버에서 온 flash attribute 존재 여부 체크
			var hasEmail = /*[[${email} != null]]*/false;
			var hasError = /*[[${error} != null]]*/false;

			// 이메일 탭을 기본 활성화(선택)
			if (location.hash === '#find-email') {
				const emailBtn = document
						.querySelector('.tab-btn[data-target="#tabEmail"]');
				if (emailBtn)
					emailBtn.click();
			}

			// 결과가 있으면 모달 표시
			if (hasEmail || hasError) {
				var modalEl = document.getElementById('findEmailResultModal');
				if (modalEl) {
					var modal = new bootstrap.Modal(modalEl);
					modal.show();
				}
			}
		});
	</script>


	<script th:inline="none">
	document.addEventListener("DOMContentLoaded", () => {
	  // 1) 비밀번호 찾기 탭의 "코드 발송" submit 가로채기
	  const pwdForm = document.querySelector('#tabPassword form[method="post"]');
	  if (pwdForm) {
	    pwdForm.addEventListener('submit', async (e) => {
	      e.preventDefault();
	
	      const formData = new FormData(pwdForm);
	      const name  = formData.get('name');
	      const phone = formData.get('phone');
	      const email = formData.get('email');
	
	      // 서버: /forgot/password/send 는 email만 받도록 되어 있음 → name/phone 검증은 서버에서 추가 로직으로 확인하든지,
	      // 여기서는 email만 넘겨 코드 발송 트리거
	      const sendUrl = pwdForm.getAttribute('th:action') ? pwdForm.action : '/forgot/password/send';
			console.log("email 보내는 값:", email);
	      try {
	        const res = await fetch(sendUrl, {
	          method: 'POST',
	          body: new URLSearchParams({ email }),
	          //headers: { 'X-CSRF-TOKEN': '[[${_csrf.token}]]' }  // CSRF 사용 시
	        });
	
	        // 컨트롤러는 redirect를 반환하지만, AJAX에선 200/302로만 옴 → 성공으로 간주하고 다음 모달로 진행
	        if (!res.ok && res.status !== 302) throw new Error('코드 전송 실패');
	
	        // 다음 단계 모달 오픈: 인증코드 입력
	        document.getElementById('verify-email').value = email;
	        const verifyModal = new bootstrap.Modal(document.getElementById('findPasswordVerifyModal'));
	        verifyModal.show();
	
	      } catch (err) {
	        alert('코드 전송에 실패했습니다. ' + err.message);
	      }
	    });
	  }
	
	  // 2) 인증코드 검증
	  const verifyForm = document.getElementById('verifyCodeForm');
	  if (verifyForm) {
	    verifyForm.addEventListener('submit', async (e) => {
	      e.preventDefault();
	      const formData = new FormData(verifyForm);
	      const email = formData.get('email');
	      const code  = formData.get('code');
	
	      try {
	        const res = await fetch(verifyForm.action || '/forgot/password/verify', {
	          method: 'POST',
	          body: new URLSearchParams({ email, code }),
	          // headers: { 'X-CSRF-TOKEN': '[[${_csrf.token}]]' }
	        });
	
	        if (res.ok || res.status === 302) {
	          // 인증 성공 → reset 모달로
	         const verifyModalEl = document.getElementById('findPasswordVerifyModal');
 			if (verifyModalEl) bootstrap.Modal.getInstance(verifyModalEl)?.hide();
	          
	          const accountModalEl = document.getElementById('findAccountModal');
  			if (accountModalEl) bootstrap.Modal.getInstance(accountModalEl)?.hide();
	
	          document.getElementById('reset-email').value = email;
	          const resetModal = new bootstrap.Modal(document.getElementById('findPasswordResetModal'));
	          resetModal.show();
	        } else {
	          throw new Error('인증 실패');
	        }
	      } catch (err) {
	        const el = document.getElementById('verify-error');
	        el.textContent = '인증 코드가 올바르지 않거나 만료되었습니다.';
	        el.style.display = 'block';
	      }
	    });
	  }
	
	  // 2-1) 코드 재전송
	  const resendBtn = document.getElementById('resend-code-btn');
	  if (resendBtn) {
	    resendBtn.addEventListener('click', async () => {
	      const email = (document.getElementById('verify-email') || {}).value;
	      if (!email) return;
	      const msg = document.getElementById('resend-msg');
	      try {
	        const res = await fetch('/forgot/password/send', {
	          method: 'POST',
	          body: new URLSearchParams({ email }),
	          // headers: { 'X-CSRF-TOKEN': '[[${_csrf.token}]]' }
	        });
	        if (res.ok || res.status === 302) {
	          msg.textContent = '코드를 재전송했습니다.';
	        } else {
	          msg.textContent = '재전송 실패';
	        }
	      } catch {
	        msg.textContent = '재전송 실패';
	      }
	      setTimeout(() => msg.textContent = '', 3000);
	    });
	  }
	
	  // 3) 새 비밀번호 저장
	  const resetForm = document.getElementById('resetPwdForm');
	  if (resetForm) {
	    resetForm.addEventListener('submit', async (e) => {
	      e.preventDefault();
	      const fd = new FormData(resetForm);
	      const email = fd.get('email');
	      const password = fd.get('password');
	      const confirm  = fd.get('confirm');
	
	      try {
	        const res = await fetch(resetForm.action || '/forgot/password/reset', {
	          method: 'POST',
	          body: new URLSearchParams({ email, password, confirm }),
	        });
	
	        if (res.ok || res.status === 302) {
	          const resetModalEl = document.getElementById('findPasswordResetModal');
        	bootstrap.Modal.getInstance(resetModalEl)?.hide();

  
       		 const successModal = new bootstrap.Modal(document.getElementById('resetPasswordSuccessModal'));
       		 successModal.show();
	        } else {
	          throw new Error('변경 실패');
	        }
	      } catch (err) {
	        const el = document.getElementById('reset-error');
	        el.textContent = '비밀번호 변경에 실패했습니다. (불일치/서버 오류)';
	        el.style.display = 'block';
	      }
	    });
	  }
	});
</script>



	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>